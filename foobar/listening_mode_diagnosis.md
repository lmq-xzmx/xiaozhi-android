# "å§‹ç»ˆå¤„äºŽListeningæ¨¡å¼"é—®é¢˜è¯Šæ–­

## é—®é¢˜çŽ°çŠ¶

âœ… **å·²è§£å†³**: ä¸¤ç§æœåŠ¡å™¨ç±»åž‹éƒ½èƒ½è¿žæŽ¥å¹¶è¿›å…¥èŠå¤©ç•Œé¢
âŒ **å¾…è§£å†³**: æ¨¡åž‹ä¸€ç›´å¤„äºŽlisteningçŠ¶æ€ï¼Œæ²¡æœ‰è¯­éŸ³è¯†åˆ«åé¦ˆ

## è¯­éŸ³å¤„ç†æµç¨‹åˆ†æž

### æ­£å¸¸çš„è¯­éŸ³è¯†åˆ«æµç¨‹åº”è¯¥æ˜¯ï¼š

1. **éŸ³é¢‘å½•åˆ¶** â†’ AudioRecorderé‡‡é›†éº¦å…‹é£Žæ•°æ®
2. **éŸ³é¢‘ç¼–ç ** â†’ OpusEncoderå°†PCMæ•°æ®ç¼–ç ä¸ºOpusæ ¼å¼
3. **æ•°æ®å‘é€** â†’ é€šè¿‡WebSocketå‘é€åˆ°æœåŠ¡å™¨
4. **æœåŠ¡å™¨å¤„ç†** â†’ æœåŠ¡å™¨è¿›è¡Œè¯­éŸ³è¯†åˆ«(STT)
5. **ç»“æžœè¿”å›ž** â†’ æœåŠ¡å™¨è¿”å›žè¯†åˆ«çš„æ–‡æœ¬
6. **UIæ›´æ–°** â†’ æ˜¾ç¤ºç”¨æˆ·è¯´è¯å†…å®¹å’ŒAIå›žå¤

### å¯èƒ½çš„æ•…éšœç‚¹ï¼š

## 1. éŸ³é¢‘æƒé™é—®é¢˜ ðŸŽ¤
**ç—‡çŠ¶**: AudioRecorderåˆå§‹åŒ–å¤±è´¥
**æ£€æŸ¥æ–¹æ³•**: æŸ¥çœ‹æ—¥å¿—ä¸­æ˜¯å¦æœ‰"Security exception - missing audio permission"

## 2. éŸ³é¢‘å½•åˆ¶ç¡¬ä»¶é—®é¢˜ ðŸ”§
**ç—‡çŠ¶**: AudioRecorderåˆ›å»ºæˆåŠŸä½†æ— æ³•é‡‡é›†æ•°æ®
**æ£€æŸ¥æ–¹æ³•**: æŸ¥çœ‹"Audio frames processed"è®¡æ•°æ˜¯å¦å¢žé•¿

## 3. Opusç¼–ç å™¨é—®é¢˜ ðŸ“¦
**ç—‡çŠ¶**: å½•åˆ¶åˆ°éŸ³é¢‘ä½†ç¼–ç å¤±è´¥
**æ£€æŸ¥æ–¹æ³•**: æŸ¥çœ‹"Opus encoding returned null"è­¦å‘Š

## 4. ç½‘ç»œå‘é€é—®é¢˜ ðŸŒ
**ç—‡çŠ¶**: ç¼–ç æˆåŠŸä½†æ•°æ®æœªå‘é€åˆ°æœåŠ¡å™¨
**æ£€æŸ¥æ–¹æ³•**: æŸ¥çœ‹WebSocketå‘é€æ—¥å¿—å’Œ"Audio frames sent"è®¡æ•°

## 5. æœåŠ¡å™¨åè®®é—®é¢˜ ðŸ–¥ï¸
**ç—‡çŠ¶**: æ•°æ®å‘é€æˆåŠŸä½†æœåŠ¡å™¨ä¸è¯†åˆ«æˆ–æ— å“åº”
**æ£€æŸ¥æ–¹æ³•**: æŸ¥çœ‹æ˜¯å¦æ”¶åˆ°æœåŠ¡å™¨çš„STTå“åº”

## 6. å“åº”å¤„ç†é—®é¢˜ ðŸ“¨
**ç—‡çŠ¶**: æœåŠ¡å™¨æœ‰å“åº”ä½†å®¢æˆ·ç«¯æœªæ­£ç¡®å¤„ç†
**æ£€æŸ¥æ–¹æ³•**: æŸ¥çœ‹incomingJsonFlowçš„æ¶ˆæ¯å¤„ç†

## è¯Šæ–­æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥åŸºç¡€æ—¥å¿—
è¿è¡Œä»¥ä¸‹å‘½ä»¤æ”¶é›†å…³é”®æ—¥å¿—ï¼š
```bash
adb logcat -s AudioRecorder ChatViewModel WS OpusEncoder OpusDecoder
```

### ç¬¬äºŒæ­¥ï¼šå…³é”®æ—¥å¿—æ ‡è¯†

**éŸ³é¢‘å½•åˆ¶æ­£å¸¸åº”è¯¥çœ‹åˆ°**:
```
AudioRecorder: Starting audio recording...
AudioRecorder: AudioRecord initialized successfully
AudioRecorder: Audio recording thread started
AudioRecorder: Audio frames processed: 100, last frame size: 1920 bytes
```

**éŸ³é¢‘ç¼–ç æ­£å¸¸åº”è¯¥çœ‹åˆ°**:
```
ChatViewModel: OpusEncoder created successfully
ChatViewModel: Encoding audio frame: 1920 bytes
ChatViewModel: Sending audio frame #1: 120 bytes
ChatViewModel: Audio frames sent: 50
```

**WebSocketå‘é€æ­£å¸¸åº”è¯¥çœ‹åˆ°**:
```
WS: Sending audio frame data (binary)
```

**æœåŠ¡å™¨å“åº”æ­£å¸¸åº”è¯¥çœ‹åˆ°**:
```
WS: Received text message: {"type":"stt","text":"ç”¨æˆ·è¯´çš„è¯"}
ChatViewModel: >> ç”¨æˆ·è¯´çš„è¯
```

### ç¬¬ä¸‰æ­¥ï¼šé—®é¢˜å®šä½

**å¦‚æžœåœåœ¨æŸä¸ªæ­¥éª¤**:

1. **éŸ³é¢‘å½•åˆ¶å¤±è´¥** â†’ æ£€æŸ¥å½•éŸ³æƒé™ã€è®¾å¤‡éŸ³é¢‘æ”¯æŒ
2. **ç¼–ç å¤±è´¥** â†’ Opusåº“é—®é¢˜ï¼Œå¯èƒ½éœ€è¦æ£€æŸ¥NDKç¼–è¯‘
3. **å‘é€å¤±è´¥** â†’ WebSocketè¿žæŽ¥é—®é¢˜
4. **æ— æœåŠ¡å™¨å“åº”** â†’ æœåŠ¡å™¨ç«¯é—®é¢˜æˆ–åè®®ä¸åŒ¹é…
5. **å“åº”æœªå¤„ç†** â†’ å®¢æˆ·ç«¯JSONè§£æžé—®é¢˜

## å¸¸è§åŽŸå› å’Œè§£å†³æ–¹æ¡ˆ

### å½•éŸ³æƒé™é—®é¢˜
```kotlin
// åœ¨MainActivityä¸­ç¡®è®¤æƒé™å·²æŽˆäºˆ
if (ContextCompat.checkSelfPermission(this, Manifest.permission.RECORD_AUDIO) 
    != PackageManager.PERMISSION_GRANTED) {
    // æƒé™æœªæŽˆäºˆ
}
```

### æœåŠ¡å™¨åè®®ä¸åŒ¹é…
**å¯èƒ½çš„é—®é¢˜**:
- æœåŠ¡å™¨æœŸæœ›ä¸åŒçš„éŸ³é¢‘æ ¼å¼
- æœåŠ¡å™¨ä¸æ”¯æŒå®žæ—¶è¯­éŸ³è¯†åˆ«
- è®¤è¯æˆ–ä¼šè¯é—®é¢˜

### éŸ³é¢‘å‚æ•°ä¸åŒ¹é…
**æ£€æŸ¥ç‚¹**:
- é‡‡æ ·çŽ‡ï¼šå®¢æˆ·ç«¯16kHz vs æœåŠ¡å™¨æœŸæœ›
- éŸ³é¢‘æ ¼å¼ï¼šOpus vs å…¶ä»–æ ¼å¼
- å¸§å¤§å°ï¼š60ms vs æœåŠ¡å™¨æœŸæœ›

## å¿«é€ŸæŽ’æŸ¥å‘½ä»¤

```bash
# æ£€æŸ¥åº”ç”¨æ˜¯å¦æœ‰å½•éŸ³æƒé™
adb shell dumpsys package info.dourok.voicebot | grep RECORD_AUDIO

# å®žæ—¶æŸ¥çœ‹éŸ³é¢‘ç›¸å…³æ—¥å¿—
adb logcat | grep -E "(AudioRecorder|OpusEncoder|ChatViewModel.*audio|WS.*audio)"

# æŸ¥çœ‹æœåŠ¡å™¨å“åº”
adb logcat | grep -E "(WS.*Received|ChatViewModel.*>>|ChatViewModel.*<<")"

# æ£€æŸ¥æƒé™å’ŒéŸ³é¢‘è®¾å¤‡çŠ¶æ€
adb shell dumpsys audio | grep -A 10 -B 10 "RECORD"
```

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **è¿è¡Œæ—¥å¿—æ”¶é›†å‘½ä»¤**
2. **å¯¹æ¯”æ­£å¸¸æµç¨‹æ£€æŸ¥ç‚¹**
3. **æ ¹æ®åœæ­¢çš„æ­¥éª¤å®šä½å…·ä½“é—®é¢˜**
4. **å®žæ–½å¯¹åº”çš„ä¿®å¤æ–¹æ¡ˆ**

é€šè¿‡è¯¦ç»†çš„æ—¥å¿—åˆ†æžï¼Œæˆ‘ä»¬å¯ä»¥ç²¾ç¡®å®šä½"å§‹ç»ˆlistening"é—®é¢˜çš„æ ¹æœ¬åŽŸå› ã€‚ 