# ğŸš€ å¹¶è¡Œå¼€å‘æ‰§è¡Œè®¡åˆ’

## ğŸ“Š å¹¶è¡Œå¼€å‘ç­–ç•¥ï¼ˆé€‰é¡¹Cï¼‰

åŸºäºæ‚¨çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å°†åŒæ—¶æ¨è¿›ä¸‰ä¸ªé˜¶æ®µï¼Œé‡‡ç”¨å¹¶è¡Œå¼€å‘æ¨¡å¼ï¼š

### ğŸ¯ å¹¶è¡Œå¼€å‘ä¼˜åŠ¿ï¼š
- âš¡ **åŠ é€Ÿå¼€å‘**ï¼šå¤šæ¡çº¿å¹¶è¡Œæ¨è¿›
- ğŸ”„ **å¿«é€Ÿè¿­ä»£**ï¼šæ¯å¤©éƒ½æœ‰å¯è§æˆæœ  
- ğŸ›¡ï¸ **é£é™©åˆ†æ•£**ï¼šå•ä¸ªæ¨¡å—é—®é¢˜ä¸å½±å“æ•´ä½“è¿›åº¦
- ğŸ“ˆ **ä»·å€¼æœ€å¤§åŒ–**ï¼šä¼˜å…ˆçº§çµæ´»è°ƒæ•´

## ğŸ“… ä¸‰é˜¶æ®µå¹¶è¡Œæ—¶é—´çº¿

### ç¬¬1å¤©ï¼šå¤šçº¿å¯åŠ¨
```
ä¸Šåˆï¼ˆ4å°æ—¶ï¼‰ï¼š
â”œâ”€â”€ çº¿ç¨‹Aï¼šéªŒè¯å½“å‰STTåŠŸèƒ½ + å¼€å§‹æ‰‹åŠ¨ç»‘å®šä¼˜åŒ–ï¼ˆ2å°æ—¶ï¼‰
â”œâ”€â”€ çº¿ç¨‹Bï¼šOTAå®¢æˆ·ç«¯æ¶æ„è®¾è®¡ï¼ˆ2å°æ—¶ï¼‰  
â””â”€â”€ çº¿ç¨‹Cï¼šESP32 vs Androidå·®å¼‚åˆ†æå®Œå–„ï¼ˆå·²å®Œæˆï¼‰

ä¸‹åˆï¼ˆ4å°æ—¶ï¼‰ï¼š
â”œâ”€â”€ çº¿ç¨‹Aï¼šè®¾å¤‡ç®¡ç†ä¼˜åŒ–å®ç°ï¼ˆ2å°æ—¶ï¼‰
â”œâ”€â”€ çº¿ç¨‹Bï¼šç½‘ç»œå±‚åŸºç¡€å®ç°ï¼ˆ2å°æ—¶ï¼‰
â””â”€â”€ é›†æˆæµ‹è¯•ï¼šå„æ¨¡å—æ¥å£å¯¹æ¥éªŒè¯
```

### ç¬¬2å¤©ï¼šæ·±åŒ–å®ç°
```
ä¸Šåˆï¼ˆ4å°æ—¶ï¼‰ï¼š
â”œâ”€â”€ çº¿ç¨‹Aï¼šç”¨æˆ·ä½“éªŒæå‡ï¼ˆç»‘å®šçŠ¶æ€UIï¼‰ï¼ˆ2å°æ—¶ï¼‰
â”œâ”€â”€ çº¿ç¨‹Bï¼šOTAæœåŠ¡æ¥å£å®ç°ï¼ˆ2å°æ—¶ï¼‰

ä¸‹åˆï¼ˆ4å°æ—¶ï¼‰ï¼š
â”œâ”€â”€ çº¿ç¨‹Aï¼šé…ç½®ç®¡ç†æŒä¹…åŒ–ï¼ˆ2å°æ—¶ï¼‰  
â”œâ”€â”€ çº¿ç¨‹Bï¼šè‡ªåŠ¨ç»‘å®šæµç¨‹æ ¸å¿ƒé€»è¾‘ï¼ˆ2å°æ—¶ï¼‰
```

### ç¬¬3å¤©ï¼šé›†æˆä¼˜åŒ–
```
ä¸Šåˆï¼ˆ4å°æ—¶ï¼‰ï¼š
â”œâ”€â”€ çº¿ç¨‹Aï¼šæ‰‹åŠ¨ç»‘å®šæ–¹æ¡ˆå®Œå–„å’Œæµ‹è¯•ï¼ˆ2å°æ—¶ï¼‰
â”œâ”€â”€ çº¿ç¨‹Bï¼šæ™ºèƒ½ç»‘å®šUIé›†æˆï¼ˆ2å°æ—¶ï¼‰

ä¸‹åˆï¼ˆ4å°æ—¶ï¼‰ï¼š
â”œâ”€â”€ ç»Ÿä¸€ç®¡ç†ç•Œé¢è®¾è®¡ï¼ˆ2å°æ—¶ï¼‰
â””â”€â”€ å®Œæ•´æµç¨‹é›†æˆæµ‹è¯•ï¼ˆ2å°æ—¶ï¼‰
```

## ğŸ”„ ç«‹å³å¼€å§‹ï¼šç¬¬ä¸€æ­¥æ‰§è¡Œ

### ç«‹å³æ‰§è¡Œä»»åŠ¡åˆ—è¡¨ï¼š

#### âœ… ä»»åŠ¡1ï¼šéªŒè¯å½“å‰STTåŠŸèƒ½ï¼ˆ30åˆ†é’Ÿï¼‰
```bash
# 1. æµ‹è¯•è®¾å¤‡ç»‘å®šçŠ¶æ€
python3 test_your_device_id.py

# 2. æ¸…é™¤åº”ç”¨æ•°æ®ï¼ˆæ‰‹åŠ¨åœ¨è®¾å¤‡ä¸Šï¼‰
# è®¾ç½® â†’ åº”ç”¨ç®¡ç† â†’ VoiceBot â†’ å­˜å‚¨ â†’ æ¸…é™¤æ•°æ®

# 3. é‡æ–°ç¼–è¯‘è¿è¡Œ
./gradlew app:assembleDebug
```

#### ğŸ”¥ ä»»åŠ¡2ï¼šå¹¶è¡Œå¯åŠ¨ - è®¾å¤‡é…ç½®ç®¡ç†å™¨ï¼ˆ90åˆ†é’Ÿï¼‰
åˆ›å»ºè®¾å¤‡é…ç½®ç®¡ç†çš„æ ¸å¿ƒç»„ä»¶ï¼š

##### 2.1 åˆ›å»ºDeviceConfigManager
```kotlin
// app/src/main/java/info/dourok/voicebot/config/DeviceConfigManager.kt
class DeviceConfigManager(private val context: Context) {
    private val dataStore = context.createDataStore("device_config")
    
    companion object {
        val DEVICE_ID_KEY = stringPreferencesKey("device_id")
        val BINDING_STATUS_KEY = booleanPreferencesKey("binding_status")
        val LAST_CHECK_TIME_KEY = longPreferencesKey("last_check_time")
        val ACTIVATION_CODE_KEY = stringPreferencesKey("activation_code")
    }
    
    suspend fun getDeviceId(): String {
        return dataStore.data.first()[DEVICE_ID_KEY] ?: "00:11:22:33:44:55"
    }
    
    suspend fun setDeviceId(deviceId: String) {
        dataStore.edit { prefs ->
            prefs[DEVICE_ID_KEY] = deviceId
        }
    }
    
    suspend fun getBindingStatus(): Boolean {
        return dataStore.data.first()[BINDING_STATUS_KEY] ?: false
    }
    
    suspend fun updateBindingStatus(isbound: Boolean) {
        dataStore.edit { prefs ->
            prefs[BINDING_STATUS_KEY] = isbound
            prefs[LAST_CHECK_TIME_KEY] = System.currentTimeMillis()
        }
    }
}
```

##### 2.2 åˆ›å»ºç»‘å®šçŠ¶æ€æ£€æŸ¥å™¨
```kotlin  
// app/src/main/java/info/dourok/voicebot/binding/BindingStatusChecker.kt
class BindingStatusChecker(
    private val deviceConfigManager: DeviceConfigManager,
    private val context: Context
) {
    
    suspend fun checkBindingStatus(): BindingCheckResult {
        val deviceId = deviceConfigManager.getDeviceId()
        
        return try {
            val response = performOTACheck(deviceId)
            
            when {
                response.has("activation") -> {
                    val activationCode = response.getJSONObject("activation").getString("code")
                    BindingCheckResult.Unbound(deviceId, activationCode)
                }
                response.has("websocket") -> {
                    val websocketUrl = response.getJSONObject("websocket").getString("url")
                    BindingCheckResult.Bound(deviceId, websocketUrl)
                }
                else -> {
                    BindingCheckResult.Error("Invalid server response")
                }
            }
        } catch (e: Exception) {
            BindingCheckResult.Error("Network error: ${e.message}")
        }
    }
    
    private suspend fun performOTACheck(deviceId: String): JSONObject {
        // ä½¿ç”¨ç°æœ‰çš„OTAæ£€æŸ¥é€»è¾‘
        // ... å®ç°ç»†èŠ‚
    }
}

sealed class BindingCheckResult {
    data class Bound(val deviceId: String, val websocketUrl: String) : BindingCheckResult()
    data class Unbound(val deviceId: String, val activationCode: String) : BindingCheckResult()
    data class Error(val message: String) : BindingCheckResult()
}
```

#### ğŸ¨ ä»»åŠ¡3ï¼šå¹¶è¡Œå¯åŠ¨ - è®¾å¤‡é…ç½®UIï¼ˆ60åˆ†é’Ÿï¼‰
åˆ›å»ºè®¾å¤‡é…ç½®ç•Œé¢ï¼š

```kotlin
// app/src/main/java/info/dourok/voicebot/ui/config/DeviceConfigScreen.kt
@Composable
fun DeviceConfigScreen(
    viewModel: DeviceConfigViewModel = hiltViewModel()
) {
    val uiState by viewModel.uiState.collectAsState()
    
    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(16.dp)
    ) {
        Text(
            text = "è®¾å¤‡é…ç½®",
            style = MaterialTheme.typography.headlineMedium,
            modifier = Modifier.padding(bottom = 16.dp)
        )
        
        // è®¾å¤‡IDé…ç½®å¡ç‰‡
        DeviceIdConfigCard(
            deviceId = uiState.deviceId,
            onDeviceIdChange = viewModel::updateDeviceId,
            onSave = viewModel::saveDeviceId
        )
        
        Spacer(modifier = Modifier.height(16.dp))
        
        // ç»‘å®šçŠ¶æ€å¡ç‰‡  
        BindingStatusCard(
            bindingStatus = uiState.bindingStatus,
            lastCheckTime = uiState.lastCheckTime,
            onRefresh = viewModel::checkBindingStatus,
            onManualBind = viewModel::showManualBindDialog
        )
        
        Spacer(modifier = Modifier.height(16.dp))
        
        // æ¿€æ´»ç æ˜¾ç¤ºï¼ˆå¦‚æœéœ€è¦ç»‘å®šï¼‰
        if (uiState.activationCode != null) {
            ActivationCodeCard(
                activationCode = uiState.activationCode!!,
                onCopyCode = viewModel::copyActivationCode,
                onOpenManagement = viewModel::openManagementPanel
            )
        }
    }
}
```

## ğŸ¯ ä»Šæ—¥ç›®æ ‡å®Œæˆæ ‡å‡†

### âœ… ç¬¬1å¤©ç»“æŸæ—¶åº”è¾¾æˆï¼š
1. **STTåŠŸèƒ½éªŒè¯**ï¼šç¡®è®¤å½“å‰ä¿®æ­£æ˜¯å¦ç”Ÿæ•ˆ
2. **è®¾å¤‡é…ç½®ç®¡ç†å™¨**ï¼šDeviceConfigManageråŸºç¡€åŠŸèƒ½å®Œæˆ
3. **ç»‘å®šçŠ¶æ€æ£€æŸ¥å™¨**ï¼šBindingStatusCheckerèƒ½å¤Ÿæ­£å¸¸å·¥ä½œ  
4. **è®¾å¤‡é…ç½®UI**ï¼šåŸºç¡€ç•Œé¢å¯ç”¨
5. **OTAæ¶æ„è®¾è®¡**ï¼šæ ¸å¿ƒæ¥å£å’Œæ•°æ®æ¨¡å‹å®šä¹‰å®Œæˆ

### ğŸ“Š æˆåŠŸæŒ‡æ ‡ï¼š
- âœ… åº”ç”¨å¯åŠ¨æ—¶èƒ½å¤Ÿæ˜¾ç¤ºå½“å‰è®¾å¤‡ID
- âœ… å¯ä»¥æ‰‹åŠ¨ä¿®æ”¹è®¾å¤‡IDå¹¶ä¿å­˜
- âœ… ç»‘å®šçŠ¶æ€æ£€æŸ¥åŠŸèƒ½æ­£å¸¸
- âœ… æ¿€æ´»ç èƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤º
- âœ… ä¸ºæ˜å¤©çš„æ·±åº¦å¼€å‘åšå¥½å‡†å¤‡

## ğŸš€ ç«‹å³å¼€å§‹æ‰§è¡Œ

é€‰æ‹©æ‚¨å¸Œæœ›ä¼˜å…ˆå¼€å§‹çš„ä»»åŠ¡ï¼š

### é€‰é¡¹1ï¼šéªŒè¯STTåŠŸèƒ½ï¼ˆæ¨èå…ˆåšï¼‰
```bash
cd foobar && python3 test_your_device_id.py
```

### é€‰é¡¹2ï¼šå¼€å§‹ä»£ç å®ç°ï¼ˆå¹¶è¡Œè¿›è¡Œï¼‰
æˆ‘å¯ä»¥ç«‹å³ä¸ºæ‚¨åˆ›å»ºä¸Šè¿°æ ¸å¿ƒç»„ä»¶çš„ä»£ç æ–‡ä»¶

### é€‰é¡¹3ï¼šä¸¤è€…å¹¶è¡Œ
ä¸€è¾¹éªŒè¯STTï¼Œä¸€è¾¹å¼€å§‹ä»£ç æ¶æ„è®¾è®¡

**è¯·å‘Šè¯‰æˆ‘æ‚¨å¸Œæœ›ä»å“ªä¸ªä»»åŠ¡å¼€å§‹ï¼Œæˆ‘å°†ç«‹å³ä¸ºæ‚¨æä¾›å…·ä½“çš„å®ç°ä»£ç ï¼** ğŸ¯ 